services:
  # ----------------------------------------------------------------
  # 1. TRAEFIK (The Reverse Proxy)
  # ----------------------------------------------------------------
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--api.insecure=true"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - proxy_net

  # ----------------------------------------------------------------
  # 2. ADGUARD HOME (DNS Server)
  # ----------------------------------------------------------------
  adguard:
    image: adguard/adguardhome
    container_name: adguard
    restart: unless-stopped
    network_mode: host
    volumes:
      - ~/docker_data/adguard/work:/opt/adguardhome/work
      - ~/docker_data/adguard/conf:/opt/adguardhome/conf

  # ----------------------------------------------------------------
  # 3. IMMICH (Photo Management)
  # ----------------------------------------------------------------
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: immich_server
    restart: unless-stopped
    volumes:
      - ~/docker_data/immich:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    env_file: .env
    networks:
      - proxy_net
      - internal_net
    depends_on:
      - redis
      - database
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.immich.rule=Host(`images.${DOMAIN}`)"
      - "traefik.http.routers.immich.entrypoints=web"
      - "traefik.http.services.immich.loadbalancer.server.port=2283"
      # Specify which network Traefik should use
      - "traefik.docker.network=proxy_net"

  redis:
    image: redis:6.2-alpine
    container_name: immich_redis
    restart: unless-stopped
    healthcheck:
      test: redis-cli ping || exit 1
    networks:
      - internal_net

  database:
    image: docker.io/tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich_postgres
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_INITDB_ARGS: "--data-checksums"
    volumes:
      - ~/docker_data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: pg_isready --dbname='${DB_DATABASE_NAME}' --username='${DB_USERNAME}' || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal_net

networks:
  proxy_net:
    external: true
  internal_net:

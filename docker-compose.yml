#
# Home Lab Server - Docker Compose
# Traefik + AdGuard Home + Immich
#

services:
  # ----------------------------------------------------------------
  # 1. TRAEFIK (Reverse Proxy)
  # Dashboard: http://YOUR_IP:8080
  # ----------------------------------------------------------------
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=proxy_net"
      - "--entrypoints.web.address=:80"
      - "--api.insecure=true"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - proxy_net

  # ----------------------------------------------------------------
  # 2. ADGUARD HOME (DNS Server)
  # Initial setup: http://YOUR_IP:3000
  # After setup:   http://YOUR_IP (admin panel moves to port you set)
  # ----------------------------------------------------------------
  adguard:
    image: adguard/adguardhome
    container_name: adguard
    restart: unless-stopped
    network_mode: host
    volumes:
      - ~/docker_data/adguard/work:/opt/adguardhome/work
      - ~/docker_data/adguard/conf:/opt/adguardhome/conf

  # ----------------------------------------------------------------
  # 3. GLANCE (Dashboard)
  # Access via: http://home.${DOMAIN}
  # Config:     ~/docker_data/glance/glance.yml
  # ----------------------------------------------------------------
  glance:
    image: glanceapp/glance
    container_name: glance
    restart: unless-stopped
    volumes:
      - ~/docker_data/glance:/app/config:rw
      - /etc/localtime:/etc/localtime:ro
    networks:
      - proxy_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.glance.rule=Host(`home.${DOMAIN}`)"
      - "traefik.http.routers.glance.entrypoints=web"
      - "traefik.http.services.glance.loadbalancer.server.port=8080"
      - "traefik.docker.network=proxy_net"
  # ----------------------------------------------------------------
  # 4. IMMICH (Photo Management)
  # Access via: http://images.${DOMAIN}
  # Based on official Immich docker-compose (Jan 2025)
  # ----------------------------------------------------------------
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: immich_server
    restart: unless-stopped
    volumes:
      - ${UPLOAD_LOCATION}:/data
      - /etc/localtime:/etc/localtime:ro
    env_file:
      - .env
    depends_on:
      - redis
      - database
    networks:
      - proxy_net
      - internal_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.immich.rule=Host(`images.${DOMAIN}`)"
      - "traefik.http.routers.immich.entrypoints=web"
      - "traefik.http.services.immich.loadbalancer.server.port=2283"
      - "traefik.docker.network=proxy_net"
    healthcheck:
      disable: false

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    container_name: immich_machine_learning
    restart: unless-stopped
    volumes:
      - model-cache:/cache
    env_file:
      - .env
    networks:
      - internal_net
    healthcheck:
      disable: false

  redis:
    image: docker.io/valkey/valkey:8-bookworm
    container_name: immich_redis
    restart: unless-stopped
    networks:
      - internal_net
    healthcheck:
      test: redis-cli ping || exit 1

  database:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0
    container_name: immich_postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_DATABASE_NAME}
      POSTGRES_INITDB_ARGS: "--data-checksums"
    volumes:
      # NOTE: This directory must be owned by UID 999 (postgres user inside container)
      # Run: sudo chown -R 999:999 ~/docker_data/postgres
      - ${DB_DATA_LOCATION}:/var/lib/postgresql/data
    shm_size: 128mb
    networks:
      - internal_net
    healthcheck:
      disable: false

networks:
  proxy_net:
    external: true
  internal_net:

volumes:
  model-cache:
